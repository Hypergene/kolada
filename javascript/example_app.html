<!DOCTYPE html>

<!--    En fil som enkelt visar hur man kan anv&auml;nda Kolada API.
        Om du hittar fel i koden, så ber&auml;tta det g&auml;rna f&ouml;r mig: olof.adell@hypergene.se -->

<html>
    <head>
        <title>Kolada API test</title>
        <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" rel="stylesheet">
        <style>
            body {margin: 20px auto; width:960px;}
            #kpi {height: 150px; width: 400px;}
            #municipality {height: 225px;}
            .platta {background-color: #eee; border-radius: 10px; padding: 10px; float: left; margin: 20px 20px 20px 0; height: 300px;}
            h3 {margin: 0;}
            #ouSection {display: none;}
            table {clear:left; margin: 20px 0;}
            tr:nth-child(even) {background-color: #f8f8f8;}
        </style>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
        <script>
            var koladaAPI = {};
            koladaAPI.municipalities = {};
            koladaAPI.OUs = {};
            koladaAPI.KPIs = {};
            koladaAPI.selectedOUs = '';

            //Styr om man ska kunna ange år eller enhet i tredje boxen
            koladaAPI.toggleTypeVisibility = function() {
                if($('#type').val() == 'year') {
                    $('#ouSection').css('display', 'block');
                    $('#yearSection').css('display', 'none');
                    $('#year')[0].selectedIndex = 0;
                } else {
                    $('#ouSection').css('display', 'none');
                    $('#yearSection').css('display', 'block');
                    $('#ou').val('');
                }
                //eftersom vi påverkat innehållen i fält får vi ställa om vår data-fråga
                koladaAPI.makeList()
            };

            //Det är här som data hämtas in.
            koladaAPI.makeList = function() {
                var lista = $('#lista'),
                    munID = $('#municipality').val(),
                    OU = $('#ou').val(),
                    year = $('#year').val(),
                    type = $('#type').val(),
                    KPI = $('#kpi').val();

                //Töm tidigare resultat, som inte hänger ihop med val i fälten längre.
                lista.empty();

                if (munID && KPI) {
                    //OK då har vi minimum för att kunna ställa en fråga till Kolada API

                    if ((munID.length>1) || (KPI.length>1)) {
                        //Användaren har valt mer än ett nyckeltal eller område. Då måste vi använda exact-URLerna
                        if (OU) {
                            //Användaren har valt en enhet, så fråga efter den.
                            url = 'http://api.kolada.se/v1/ou/data/exact/' + KPI.join() + '/' + OU + '/' + year;
                        } else {
                            //användaren har inte angett enhet, så ställ frågan på området istället.
                            url = 'http://api.kolada.se/v1/data/exact/' + KPI.join() + '/' + munID.join() +'/' + year;
                        }
                    } else {
                        //Användaren har bara valt ett område eller nyckeltal
                        if (year.length != 4) {
                            //Användaren har valt Alla år, så ställ fråga utan år.
                            if (OU) {
                                //Användaren har valt en enhet, så fråga efter den.
                                url = 'http://api.kolada.se/v1/ou/data/perou/' + KPI.join() + '/' + OU;
                            } else {
                                //Användaren har inte valt en enhet, så fråga efter området.
                                url = 'http://api.kolada.se/v1/data/permunicipality/' + KPI.join() + '/' + munID.join();
                            }
                        } else {
                            //Användaren har valt ett år, så fråga specifikt efter det.
                            if (OU) {
                                //Användaren har valt en enhet, så fråga efter den.
                                url = 'http://api.kolada.se/v1/ou/data/exact/' + KPI.join() + '/' + OU + '/' + year;
                            } else {
                                //Användaren har inte valt en enhet, så fråga efter området.
                                url = 'http://api.kolada.se/v1/ou/data/exact/' + KPI.join() + '/' + koladaAPI.selectedOUs + '/' + year;
                            }
                        }
                    }

                    //Skriv ut url:en vi använt
                    $('#url').empty().text(url).attr('href', url);
                    if (url.length > 2000) {
                        //URL:en är för lång för att använda, tyvärr.
                        lista.append('<tr><th><div class="alert alert-error">URL:en &auml;r tyv&auml;rr f&ouml;r l&aring;ng. (' + url.length + ' tecken)</div></th></tr>');
                    } else {
                        //OK, skicka iväg vår request.
                        $.ajax({
                            url: url,
                            type: 'GET'
                        }).done(function(vals) {
                            //Här tar vi emot data från Kolada API.
                            //Börja att rensa än en gång så att inte data från olika frågor blandas.
                            var lst = $('#lista').empty();
                            if (vals.count==0) {
                                //Vi fick tydligen ingen data tillbaka
                                lst.append('<tr><th><div class="alert alert-info">Det finns ingen data f&ouml;r valda alternativ</div></th></tr>');
                            } else {
                                //OK, vi fick lite fin data, så skriv ut den. Först rubriker:
                                lst.append('<tr><th>Nyckeltal</th><th>Omr&aring;de/Enhet</th><th>&Aring;r</th><th>V&auml;rde</th><th>V&auml;rde m&auml;n</th><th>V&auml;rde kvinnor</th></tr>');

                                //Loopa igenom varje rad i svaret
                                for (var i = 0; i < vals.values.length; i++) {
                                    var val=vals.values[i],
                                        omrEnh = '',
                                        html = '';
                                    //Kolla om vi fått svar på område eller på enhet och slå upp namnet som motsvarar det ID vi fått
                                    if (val.municipality) {
                                        omrEnh = koladaAPI.municipalities[val.municipality];
                                    } else {
                                        omrEnh = koladaAPI.OUs[val.ou];
                                    }

                                    //Skriv ut den här raden
                                    html += '<tr>';
                                    //Vi får tillbaka ID på nyckeltal, så vi får översätta det till dess namn
                                    html += '    <td>' + koladaAPI.KPIs[val.kpi] + '</td>';
                                    html += '    <td>' + omrEnh + '</td>';
                                    html += '    <td>' + val.period + '</td>';
                                    html += '    <td>' + val.value + '</td>';
                                    //Inte all data innehåller värden uppdelade på kön
                                    if (val.value_m) {
                                        html += '<td>' + val.value_m + '</td>'
                                    } else {
                                        html += '<td></td>';
                                    }
                                    if (val.value_k) {
                                        html += '<td>' + val.value_k + '</td>'
                                    } else {
                                        html += '<td></td>';
                                    }
                                    html += '</tr>';
                                    lst.append(html);
                                }
                            }
                        });
                    }
                }
            };

            //Den här metoden hämtar in nyckeltal. Har användaren skrivit in ett filter så används det.
            //Kolada API returnerar inte alla nyckeltal i en request, utan kan skicka med en url för att få resten, men det struntar vi i.
            koladaAPI.loadKPIs = function() {
                var filter = $('#filter').val(),
                    url = 'http://api.kolada.se/v1/kpi';
                if (filter) {
                    url += '/' + filter;
                }
                $.ajax({
                    url: url,
                    type: 'GET'
                }).done(function(vals) {
                    var sel = $('#kpi').empty(),
                        val;
                    for (var i = 0; i < vals.values.length; i++) {
                        val=vals.values[i];
                        sel.append('<option value="' + val.id + '">' + val.id + ': ' + val.title + ' (' + val.municipality_type + ')</option>');
                        //Här bygger vi upp en dict som kan översätta ett nyckeltals ID till dess namn
                        koladaAPI.KPIs[val.id] = val.title + ' (' + val.municipality_type + ')';
                    }
                });
            };

            //Den här metoden hämtar in de enheter som finns för valt område
            koladaAPI.loadOUs = function() {
                var munID = $('#municipality').val();
                if (munID.length>1) {
                    //Det finns ingen poäng med att ladda in enheter från fler olika områden
                    var sel = $('#ou').empty().append('<option value="" selected="selected">V&auml;lj endast ett omr&aring;de</option>');
                    //Men vi vill såklart köra en ny data-fråga
                    koladaAPI.makeList();
                } else {
                    $.ajax({
                        url: 'http://api.kolada.se/v1/ou/' + munID,
                        type: 'GET'
                    }).done(function(vals) {
                        var sel = $('#ou').empty().append('<option value="" selected="selected">V&auml;lj...</option>');
                        koladaAPI.selectedOUs = '';
                        for (var i = 0; i < vals.values.length; i++) {
                            var val=vals.values[i];
                            sel.append('<option value="' + val.id + '">' + val.title + '</option>');
                            koladaAPI.OUs[val.id] = val.title;
                            if (koladaAPI.selectedOUs == '') {
                                koladaAPI.selectedOUs = val.id;
                            } else {
                                koladaAPI.selectedOUs += ',' + val.id;
                            }
                        }
                        //Nu har vi koll på vad enheter heter, så vi kan skicka en ny request efter data till Kolada API
                        //Vi måste ha koll på namnen först eftersom Kolada API bara returnerar ID till enheter i datat vi får från makeList().
                        koladaAPI.makeList();
                    });
                }
            };

            //Här laddar vi in de områden (Kommuner och Landsting) som finns i Kolada
            koladaAPI.loadMunicipalities = function(url) {
                if (!url) {
                    url = 'http://api.kolada.se/v1/municipality';
                }
                $.ajax({
                    url: url,
                    type: 'GET'
                }).done(function(vals) {
                    var sel = $('#municipality');
                    for (var i = 0; i < vals.values.length; i++) {
                        var val=vals.values[i];
                        sel.append('<option value="' + val.id + '">' + val.title + ' (' + val.type + ')</option>');
                        //Här bygger vi upp en dict som översätter områdens IDn till deras namn.
                        koladaAPI.municipalities[val.id] = val.title;
                    }

                    //Om vi inte fått alla områden får vi en URL till fler värden, så vi får skicka en fråga till
                    if (vals.next) {
                        koladaAPI.loadMunicipalities(vals.next);
                    }
                });
            };

            koladaAPI.init = function() {
                //Få jQuery att hantera cross-domain ajax på IE8 & IE9
                $.support.cors = true;
                //Hämta in de första nyckeltalen
                koladaAPI.loadKPIs();
                //Hämta in samtliga områden från Kolada API
                koladaAPI.loadMunicipalities();

                //Om användaren skriver in ett filter, så laddar vi om nyckeltalen
                $('#filter').on('keyup', koladaAPI.loadKPIs);

                //Om användaren gör val så ska vi skicka en fråga efter data
                $('#ou').on('change', koladaAPI.makeList);
                $('#kpi').on('change', koladaAPI.makeList);
                $('#year').on('change', koladaAPI.makeList);

                //Om användaren ändrar jämförelsetyp så ska vi ändra synlighet och innehåll i fälten för år och enhet.
                //Sen anropas makeList() från toggleTypeVisibility()
                $('#type').on('change', koladaAPI.toggleTypeVisibility);

                //Om användaren byter område måste vi ladda in nya enheter.
                //Sedan anropas makeList() från loadOUs() så att vi får rätt data också
                $('#municipality').on('change', koladaAPI.loadOUs);
            };

            //När allting är inladdat vill vi köra vår init-metod.
            $(document).ready(function() {
                console.log($("#dialog"));
                $( "#dialog" ).dialog({ autoOpen: true, modal: true, width: 500, height: 500 });
                koladaAPI.init();
            });

        </script>

    </head>

    <body>
        <h1>Kolada API Test</h1>
        <p>Denna sida v&auml;nder sig allts&aring; till Utvecklare.</p>
        <p>
            Den h&auml;r filen visar hur man kan anv&auml;nda Kolada API. F&ouml;r att anv&auml;nda sidan, prova till exempel:
            <ol>
                <li>Filtrera nyckeltal p&aring; <code>l&auml;rare</code></li>
                <li>V&auml;lj nyckeltalet <code>N15033: Elever/l&auml;rare (&aring;rsarbetare) i grundskola totalt, antal (K)</code></li>
                <li>(K) efter nyckeltalet indikerar att detta &auml;r ett nyckeltal f&ouml;r kommuner, s&aring; v&auml;lj nu till exempel <code>Salem (K)</code> i Kommun/Landsting</li>
            </ol>
            Eperimentera sedan med f&auml;lten i <code>Gr&auml;v djupare</code> och med att v&auml;lja flera nyckeltal eller omr&aring;den. L&auml;ngst ner p&aring; sidan visas vilket URL som anv&auml;nts f&ouml;r att h&auml;mta data.
        </p>
        <p>
            <strong>Observera</strong> att den h&auml;r sidan inte &auml;r menad att vara anv&auml;ndbar p&aring; riktigt, utan ska bara visa hur de olika delarna i Kolada API kan anv&auml;ndas och knytas samman.
        </p>
        <p>
            Dokumentation om Kolada API finns h&auml;r: <a href="http://www.kolada.se/appspecific/rka/download/api/KoladaSDKv1-dokumentation.pdf" target="_blank">pdf</a>
        </p>
        <form>
            <div class="platta">
                <h3>Nyckeltal</h3>
                <p>
                    <label for="filter">Filtrera nyckeltal</label>
                    <input type="text" id="filter" name="filter"></select>
                </p>
                <p>
                    <label for="kpi">Nyckeltal (max 100)</label>
                    <select id="kpi" name="kpi" multiple></select>
                </p>
            </div>
            <div class="platta">
                <h3>Omr&aring;den</h3>
                <p>
                    <label for="municipality">Kommun/Landsting</label>
                    <select id="municipality" name="municipality" multiple></select>
                </p>
            </div>
            <div class="platta">
                <h3>Gr&auml;v djupare</h3>
                <p>
                    <label for="type">S&ouml;ktyp</label>
                    <select id="type" name="type">
                        <option value="year" selected>J&auml;mf&ouml;r &aring;r f&ouml;r en enhet</option>
                        <option value="mun" selected="selected">J&auml;mf&ouml;r v&auml;rden ett visst &aring;r</option>
                    </select>
                </p>
                <p id="yearSection">
                    <label for="year">&Aring;r</label>
                    <select id="year" name="year">
                        <option selected="selected" value="1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012">Alla</option>
                        <option>1998</option>
                        <option>1999</option>
                        <option>2000</option>
                        <option>2001</option>
                        <option>2002</option>
                        <option>2003</option>
                        <option>2004</option>
                        <option>2005</option>
                        <option>2006</option>
                        <option>2007</option>
                        <option>2008</option>
                        <option>2009</option>
                        <option>2010</option>
                        <option>2011</option>
                        <option>2012</option>
                    </select>
                </p>
                <p id="ouSection">
                    <label for="ou">Enhet</label>
                    <select id="ou" name="ou">
                        <option>V&auml;lj ett omr&aring;de f&ouml;rst</option>
                    </select>
                </p>
            </div>
            <table id="lista" class="table"></table>
            <p class="muted">Data h&auml;mtades med denna URL: <a href="#" id="url" target="_blank">Ingen &auml;n</a><br>
        </form>
        <div id="dialog" title="Obs!">
            <p>&nbsp;</p>
            <p>
                Den h&auml;r sidan &auml;r ett exempel p&aring; hur Kolada API kan anv&auml;ndas.
            </p>
            <p>
                Sidan &auml;r inte t&auml;nkt att anv&auml;ndas i sig sj&auml;lv, utan meningen &auml;r att dess k&auml;llkod ska
                fungera som ett exempel f&ouml;r programmerare som vill utveckla egna applikationer kring datat i Kolada API.
            </p>
        </div>
    </body>
</html>